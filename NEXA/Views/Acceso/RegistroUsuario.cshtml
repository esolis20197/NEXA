@model NEXA.Models.RegistroModeloUsuario

@{
    ViewData["Title"] = "Registro de Usuario";
}

<section class="d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="card shadow-lg p-4" style="width: 100%; max-width: 700px;">
        <h2 class="text-center mb-4">Registro de Usuario</h2>

        <form asp-controller="Acceso" asp-action="RegistroUsuario" method="post" novalidate>
            <!-- Mostrar errores del modelo -->
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="NombreUsuario" class="form-label">Nombre de Usuario</label>
                    <input asp-for="NombreUsuario" class="form-control" placeholder="Ingresa tu usuario" />
                    <span asp-validation-for="NombreUsuario" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="Cedula" class="form-label">Cédula de Identidad</label>
                    <input asp-for="Cedula" id="cedulaInput" type="text" class="form-control" placeholder="Ingresa tu cédula (111110111)" />
                    <span asp-validation-for="Cedula" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="NombreCompleto" class="form-label">Nombre Completo</label>
                    <input asp-for="NombreCompleto" id="nombreCompleto" class="form-control" placeholder="Nombre completo" readonly />
                    <span asp-validation-for="NombreCompleto" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="Correo" class="form-label">Correo Electrónico</label>
                    <input asp-for="Correo" type="email" class="form-control" placeholder="Correo" />
                    <span asp-validation-for="Correo" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="Telefono" class="form-label">Teléfono</label>
                    <input asp-for="Telefono" type="text" class="form-control" pattern="\d{8}" title="Debe contener 8 dígitos" placeholder="Teléfono" />
                    <span asp-validation-for="Telefono" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="Contraseña" class="form-label">Contraseña</label>
                    <input asp-for="Contraseña" type="password" class="form-control" placeholder="Contraseña" />
                    <small class="form-text text-muted">
                        La contraseña debe tener al menos 8 caracteres, una mayúscula, una minúscula, un número y un carácter especial.
                    </small>
                    <span asp-validation-for="Contraseña" class="text-danger"></span>
                </div>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary w-100">Registrarse</button>
            </div>
        </form>

        <div class="text-center mt-3">
            <p>¿Ya tienes una cuenta? <a asp-controller="Acceso" asp-action="InicioSesion">Iniciar Sesión</a></p>
        </div>
    </div>
</section>

@section Scripts {
    <!-- Validaciones cliente -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation-unobtrusive@3.2.12/jquery.validate.unobtrusive.min.js"></script>

    <!-- SweetAlert y lógica de cédula -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const cedulaInput = document.getElementById("cedulaInput");
            const nombreCompletoInput = document.getElementById("nombreCompleto");

            function capitalizarNombre(nombre) {
                return nombre.toLowerCase().split(" ").map(palabra =>
                    palabra.charAt(0).toUpperCase() + palabra.slice(1)
                ).join(" ");
            }

            cedulaInput.addEventListener("blur", function () {
                const cedula = cedulaInput.value;

                if (cedula.length >= 9) {
                    fetch(`/Acceso/BuscarNombrePorCedula?cedula=${cedula}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.exito) {
                                const nombreFormateado = capitalizarNombre(data.nombre);
                                nombreCompletoInput.value = nombreFormateado;
                            } else {
                                nombreCompletoInput.value = "";
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Cédula no encontrada',
                                    text: 'No se encontró un nombre para esta cédula.',
                                    confirmButtonColor: '#3085d6',
                                    confirmButtonText: 'Aceptar'
                                });
                            }
                        })
                        .catch(error => {
                            console.error("Error al buscar cédula:", error);
                        });
                }
            });

        @* Mostrar error en registro si existe *@
        @if (TempData["MensajeRegistroIncorrecto"] != null)
        {
            <text>
                    Swal.fire({
                        icon: 'error',
                        title: 'Error en el registro',
                        text: '@TempData["MensajeRegistroIncorrecto"]',
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'Intentar de nuevo'
                    });
            </text>
        }
                });
    </script>
}
